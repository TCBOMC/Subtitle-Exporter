# Subtitle-Exporter
快速批量导出字幕

---

## 环境准备

- **安装ffmpeg**:
  - 官网：https://ffmpeg.org/?utm_source=chatgpt.com
  - 安装到Path(建议)：下载并解压到任意目录后将包含ffmpeg.exe和ffprobe.exe的目录添加到Path
  - 安装到程序目录：下载并解压ffmpeg.exe和ffprobe.exe到本工具exe文件所在目录下的ffmpeg文件夹内(确保ffmpeg.exe和ffprobe.exe位于./ffmpeg/ffmpeg.exe和./ffmpeg/ffprobe.exe)
- **安装spp2pgs**:
  - 官网：https://github.com/subelf/Spp2Pgs/releases
  - 安装到Path(建议)：下载并解压到任意目录后将包含spp2pgs.exe的目录添加到Path
  - 安装到程序目录：载并解压整个目录到本工具exe文件所在目录下的spp2pgs文件夹内(确保spp2pgs.exe位于./spp2pgs/spp2pgs.exe)
- **安装FontForge**:
  - 官网：https://fontforge.org/en-US/?utm_source=chatgpt.com
  - 安装到Path:下载安装包并安装，将安装目录下的bin目录添加到Path
  - 安装到程序目录(建议)：下载安装包并安装，将整个安装目录复制到本工具exe文件所在目录下的FontForge文件夹内(确保fontforge.exe位于./FontForge/bin/fontforge.exe)，完成后为FontForge文件夹添加Everyone读写权限

---

## 使用程序
<img width="902" height="648" alt="屏幕截图 2025-10-24 004507" src="https://github.com/user-attachments/assets/1d59ab9b-3f3b-4812-913e-ee5e50717725" />

- **导入文件**:
  - 使用左上角**导入文件**按钮打开文件选择窗口导入文件（支持批量导入）
  - 直接向窗口**拖入**文件（支持多选拖入）
- **编辑信息**:
  - 单击文件选中行（高亮的行）
  - 再次单机选中行的“**宽度**”，“**高度**”，“**刷新率**”列可对其中参数进行修改
  - 按住**shift**或**ctrl**可多选行
  - 点击左上角**删除**按钮可删除选中的文件（高亮的行），点击**清空**按钮可清空全部文件
  - 点击文件第一列的**复选框**可**选中/取消选中**文件（此处选中的文件为要导出字幕的文件）
  - 点击表头的**复选框**可**全选/全不选**文件
- **选择操作**:
  - 在**格式下拉栏**选择要导出的字幕格式，导出过程中如果遇到无法转换的字幕会尝试以**原格式**导出
  - 勾选**清空头部**将会清空ass或ssa字幕内[Script Info]的内参数（字幕仍可使用）
  - 在**右上角的下拉栏**内选择对字体的处理方式
  - 点击**提取字幕**提取所有**复选框被勾选**的文件的字幕

---

## 字体处理

- **封装字体**:
  - 功能：将视频文件中封装的字体文件直接**打包封装进字幕文件**(ass/ssa)中，生成的字幕文件可在没安装字幕所需字体的系统中使用(需要播放器支持)。
  - 适用场景：
    1. 导出格式为 ASS 或 SSA
    2. 原视频中包含内封字体
    3. 希望免去安装字体的麻烦
    4. 希望在无法安装字体的平台上使用
    5. 字体中需注释字体名称对应关系，如：
    ```ass
    ; Font subset: L0V8T250 - M 盈黑 PRC W9
    ; Font subset: N1ZXC2NR - 华康翩翩体W5-A
    ; Font subset: 2YHL3UE1 - 汉仪正圆-75S
    ; Font subset: XQDHK75S - Arial
    ; Font subset: DYXAW90Z - 华康海报体W12
    ; Font subset: GSXJQ180 - 汉仪旗黑 80S
    ; Font subset: ZVUR2X0K - 内海フォント-Bold
    ; Font subset: GZNYNI7K - 汉仪正圆-65S
    ; Font subset: 8A905FBC - 汉仪正圆-55S
    ; Font subset: QL2VVX8J - 汉仪旗黑 55S
    ; Font subset: ZGLXT4XU - LINE Seed JP_OTF ExtraBold
    ; Font subset: QQ3SCN4Z - 851tegakizatsu
    ```
  - 实现流程：
    ```mermaid
    flowchart TD
    A(["开始提取字幕"]) --> B["处理所有选中视频"]
    C{"输出格式是否为ASS/SSA？"} -- 是 --> D["提取视频内封字体到临时目录"]
    C -- 否 --> E["不进行此操作"]
    B --> n1["提取当前视频信息"]
    n1 --> C
    D --> n2["提取视频内所有字幕并保存成功导出为ASS/SSA的字幕"]
    n2 --> n3["将所有字体以UUencode-like编码封装到每个保存的字幕里"]
    n3 --> n4["删除所有临时目录"]
    n4 --> n5["所有视频是否处理完成？"]
    n5 -- 是 --> n6["结束操作"]
    n5 -- 否 --> n1
    n5@{ shape: diam}
    ```
- **子集合并**:
  - 功能：从每个视频文件中提取所有字体，按照字幕注释中字体名称的对应关系对字体进行重命名（包括文件名，script name，family name），将字幕中的字体名按照注释中的对应关系从内封字体名还原成字体原本的名称，所有视频都提取完成后把所有视频提取出来的同名字幕的字符集合并后导出。
  - 使用场景：
    1. 导出格式为 ASS 或 SSA
    2. 原视频中包含内封字体
    3. 字体中需注释字体名称对应关系
    4. 不希望把字体封到字幕里但又不想找原版的字体或找不到
  - 实现流程：
    ```mermaid
    flowchart TD
    A[开始提取字幕] --> B[导出ASS/SSA字幕文件]
    B --> C[提取当前视频所用字体]
    C --> D[存放到 Fonts/视频文件夹]
    D --> E[全部视频处理完成?]
    E -- 否 --> B
    E -- 是 --> F[合并所有字体子集]
    F --> G[生成全局 Fonts 文件夹 ✅]
    ```
- **字体名还原**：
  - 功能：将字幕中的字体名按照注释中的对应关系从内封字体名还原成字体原本的名称。
  - 场景：
    1. 导出格式为 ASS 或 SSA
    2. 字体中需注释字体名称对应关系
    3. 不希望以任何形式导出字体
  - 实现流程：
    ```mermaid
    flowchart TD
    A[导出ASS/SSA字幕文件] --> B[分析字幕样式区和正文内指定的字体名]
    B --> C[找到以所有格式调用的所有字体名]
    C --> D[匹配注释中原始字体映射表]
    D --> E[替换错误/临时字体名]
    E --> F[输出修复后字幕 ✅]
    ```
- **无处理**:
  - 功能：跳过所有字体相关处理操作，输出原文件
  - 场景：不需要做处理或希望自行处理
- **完整流程**:
    ```mermaid
    flowchart TD
    
    A0([开始 提取字幕]) --> A1{是否指定输出目录}
    A1 -- 否 --> A2[创建临时输出目录]
    A1 -- 是 --> A3[使用指定输出目录]
    
    A2 --> A4[遍历所有选中文件]
    A3 --> A4
    
    A4 --> B1[读取文件信息 包含 probe]
    B1 --> B2{probe 存在吗}
    B2 -- 否 --> B3[跳过该文件]
    B2 -- 是 --> B4[获取字幕流列表]
    B4 --> B5{是否存在字幕流}
    B5 -- 否 --> B6[跳过该文件]
    B5 -- 是 --> B7[检测字幕格式和编码]
    
    B7 --> C1[读取当前字体处理模式]
    C1 --> C2{模式为 封装字体 且 输出含 ass 或 ssa 吗}
    C2 -- 是 --> C3[提取视频内嵌字体到临时目录]
    C2 -- 否 --> C4[跳过提前提取字体]
    
    C3 --> D1[循环处理每个字幕流]
    C4 --> D1
    D1 --> D2[尝试导出或转换单个字幕轨]
    D2 --> D3[记录已生成的字幕文件]
    D3 --> D4[更新字体映射表]
    D4 --> D5{该视频所有流处理完成吗}
    D5 -- 否 --> D1
    D5 -- 是 --> D6[进入后续字体处理]
    
    D6 --> E1{目标格式为 sup 吗}
    E1 -- 是 --> E2[清理临时字体并跳过后续字体处理]
    E1 -- 否 --> F1[继续字体处理分支]
    
    F1 --> F2{模式为 子集合并 且 输出含 ass 或 ssa 吗}
    F2 -- 是 --> F3[创建 Fonts 目录和视频子目录]
    F3 --> F4[从视频中提取字体子集到对应目录]
    F4 --> F5[标记需要合并字体]
    F2 -- 否 --> G1{模式为 封装字体 且 临时字体存在吗}
    
    G1 -- 是 --> G2[遍历本视频生成的字幕文件]
    G2 --> G3{字幕文件为 ass 或 ssa 吗}
    G3 -- 是 --> G4[将临时字体封装到字幕文件中]
    G3 -- 否 --> G5[跳过此字幕文件]
    G4 --> G6[删除临时字体目录]
    G5 --> G6
    G1 -- 否 --> H1[继续处理下一个视频]
    
    H1 --> H2{所有视频处理完成吗}
    H2 -- 否 --> A4
    H2 -- 是 --> H3{模式为 子集合并 且 标记需要合并为真吗}
    H3 -- 是 --> H4[合并所有视频字体到 Fonts 根目录]
    H3 -- 否 --> I1[跳过合并]
    
    H4 --> I1
    I1 --> I2{是否使用临时输出目录}
    I2 -- 否 --> I7[结束处理]
    I2 -- 是 --> I3{是否导出提取的字体}
    I3 -- 是 --> I4[让用户选择导出目录并复制 Fonts 目录]
    I3 -- 否 --> I5[跳过字体导出]
    I4 --> I6[删除临时输出目录]
    I5 --> I6
    I6 --> I7[结束处理并提示完成]
    
    I7 --> Z([字幕提取完成])
    
    %% 子流程: 单轨导出
    subgraph 单轨导出流程
     S1[接收单个字幕流信息] --> S2{原始格式 与 目标格式 相同吗}
     S2 -- 是 --> S3[直接拷贝字幕轨]
     S2 -- 否 --> S4{目标为 sup 吗}
     S4 -- 是 --> S5[使用 sup 专用转换并返回]
     S4 -- 否 --> S6[使用工具转换为目标格式]
     S6 --> S7{转换失败吗}
     S7 -- 否 --> S8[导出成功 返回路径]
     S7 -- 是 --> S9[尝试回退为原始格式拷贝]
     S9 --> S10{回退仍失败吗}
     S10 -- 是 --> S11[记录错误 返回失败]
     S10 -- 否 --> S12[返回回退导出路径]
    
     S8 --> S13{导出为 ass 或 ssa 且 字体模式不为 无 吗}
     S13 -- 是 --> S14[修复 ass 头部信息]
     S14 --> S15{字体模式为 子集合并 或 字体名还原 吗}
     S15 -- 是 --> S16[执行字体名还原并返回映射]
     S15 -- 否 --> S17[直接返回导出路径]
     S16 --> S17
     S11 --> S17
     S12 --> S17
    end
    ```
